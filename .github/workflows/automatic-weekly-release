name: automatic-weekly-release

on:
  schedule:
    - cron: "0 8 * * TUE"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal --filter "FullyQualifiedName!~MiniTwit.Web.Tests"


  release:
    runs-on: ubuntu-latest
    needs: build-and-test   # only runs if build-and-test succeeded

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Create .env file
        run: |
          echo "ASPNETCORE_ENVIRONMENT=Production" >> src/MiniTwit.Web/.env
          echo "AUTHENTICATION_GITHUB_CLIENTID=clientID" >> src/MiniTwit.Web/.env
          echo "AUTHENTICATION_GITHUB_CLIENTSECRET=clientSecret" >> src/MiniTwit.Web/.env

      - name: Publish Linux
        run: dotnet publish src/MiniTwit.Web/MiniTwit.Web.csproj -c Release -r linux-x64 --self-contained false /p:PublishSingleFile=true /p:UseAppHost=true -o out/linux
        
      - name: Publish Windows
        run: dotnet publish src/MiniTwit.Web/MiniTwit.Web.csproj -c Release -r win-x64 --self-contained false /p:PublishSingleFile=true /p:UseAppHost=true -o out/win

      - name: Publish macOS
        run: dotnet publish src/MiniTwit.Web/MiniTwit.Web.csproj -c Release -r osx-x64 --self-contained false /p:PublishSingleFile=true /p:UseAppHost=true -o out/macos

      - name: Copy .env to outputs
        run: |
          cp src/MiniTwit.Web/.env out/linux/.env
          cp src/MiniTwit.Web/.env out/win/.env
          cp src/MiniTwit.Web/.env out/macos/.env

      - name: Package executables
        run: |
          cd out
          zip -r ../MiniTwit-linux-x64.zip linux/
          zip -r ../MiniTwit-win-x64.zip win/
          zip -r ../MiniTwit-osx-x64.zip macos/

      - name: Generate release date
        id: date
        run: echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
        tag_name: tag_name: ${{ env.RELEASE_DATE }}
        Name: Weekly-release: ${{ env.RELEASE_DATE }}
          files: |
            MiniTwit-linux-x64.zip
            MiniTwit-win-x64.zip
            MiniTwit-osx-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
